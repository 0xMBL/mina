import Page from '@reason/pages/Docs';
export default Page({title: "Archive Node"});

# Archive Node

Need to access historical blockchain data? Query for historical blockchain data using the Archive node.
The Archive node is comprised of three parts:
1. Coda daemon 
2. Lightweight archive process 
3. Postgres database 

## Prerequisites
1. You'll need a working version of Coda installed. Get the latest version of the daemon [here](/docs/getting-started).
2. Install the correct Postgres database package for your operating system. [here](https://www.postgresql.org/download/).
    - For MacOS users, you can install Postgres with ```brew install postgresql```. That will give you both the Postgres server and the command line console (psql). 
    - For Windows and Linux installers, follow [here](https://www.postgresql.org/download/windows/).
    
## Installation
(insert steps here)
### macOS
### Windows 

## Running the archive node
1. Run ```createdb archiver``` to create a new Postgres database. 
2. Start the archive node. 
3. Start the coda daemon and point it to the archive node.
4. Run ```psql -d archiver``` to connect to the archiver database. 

## Try a query
### Example 1: Find the block that contains a specific transaction

### Example 2: Recursively traverse blockchain
This query recursively traverses the blockchain from the longest tip
backwards until it reaches a block of the given height. 

WITH RECURSIVE chain AS (
SELECT id, state_hash, parent_id, creator_id, snarked_ledger_hash_id, ledger_hash, height, timestamp, coinbase_id FROM blocks b WHERE height = (select MAX(height) from blocks)
UNION ALL
SELECT b.id, b.state_hash, b.parent_id, b.creator_id, b.snarked_ledger_hash_id, b.ledger_hash, b.height, b.timestamp, b.coinbase_id FROM blocks b
INNER JOIN chain
ON b.id = chain.parent_id
) SELECT c.id, c.state_hash, c.parent_id, c.creator_id, c.snarked_ledger_hash_id, c.ledger_hash, c.height, c.timestamp, c.coinbase_id, pk.value as creator FROM chain c
INNER JOIN public_keys pk
ON pk.id = c.creator_id
WHERE c.height = ?
|}